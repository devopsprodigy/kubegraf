/*! For license information please see module.js.LICENSE.txt */
define(["app/core/app_events"],(function(t){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var a=e[r]={i:r,l:!1,exports:{}};return t[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(r,a,function(e){return t[e]}.bind(null,a));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/",n(n.s=13)}({0:function(t,e,n){"use strict";n.d(e,"d",(function(){return r})),n.d(e,"j",(function(){return a})),n.d(e,"h",(function(){return s})),n.d(e,"g",(function(){return o})),n.d(e,"f",(function(){return i})),n.d(e,"c",(function(){return u})),n.d(e,"b",(function(){return c})),n.d(e,"a",(function(){return l})),n.d(e,"e",(function(){return p})),n.d(e,"i",(function(){return m}));var r=3,a=2,s=1,o=0,i=4,u="#ffff0096",c="#a52a2a",l="#299c46",p=10,m="prometheus"},1:function(t,e,n){"use strict";n.d(e,"b",(function(){return a})),n.d(e,"a",(function(){return s})),n.d(e,"c",(function(){return o})),n.d(e,"e",(function(){return i})),n.d(e,"d",(function(){return c}));var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function a(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function s(t,e,n,r){return new(n||(n=Promise))((function(a,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function i(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,i)}u((r=r.apply(t,e||[])).next())}))}function o(t,e){var n,r,a,s,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&s[0]?r.return:s[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,s[1])).done)return a;switch(r=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){o.label=s[1];break}if(6===s[0]&&o.label<a[1]){o.label=a[1],a=s;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(s);break}a[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}}function i(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function u(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,a,s=n.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(t){a={error:t}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(a)throw a.error}}return o}function c(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(u(arguments[e]));return t}},13:function(t,e,n){"use strict";n.r(e);var r=n(1),a=n(2),s=n.n(a),o=function(){function t(t,e,n){this.backendSrv=e,this.templateSrv=n,this.name=t.name,this.url=t.url,this.id=t.id,this.prometheus=t.jsonData.prom_name,this.refreshRate=t.jsonData.refresh_pods_rate,this.nodesPromise=null,this.deploymentsPromise=null,this.daemonsetsPromise=null,this.statefulsetsPromise=null,this.accessViaToken=t.jsonData.access_via_token}return t.prototype.testDatasource=function(t){void 0===t&&(t=!1);var e=this.url;return this.accessViaToken&&(e+="/__proxy"),e+="/api/v1/namespaces",this.backendSrv.datasourceRequest({url:e,method:"GET",headers:{"Content-Type":"application/json"},silent:t}).then((function(t){return t&&200===t.status?{status:"success",message:"Data source is OK",title:"Success"}:{status:"error",message:"Data source is not OK",title:"Error"}}),(function(t){return t&&t.status&&t.statusText?{status:"error",message:t.statusText,title:t.status}:{status:"error",message:"Data source is not OK",title:"Error"}}))},t.prototype.metricFindQuery=function(t){var e=this,n=this.templateSrv.replace(t,{}).split(" ");switch(n[0]){case"prom":return Promise.resolve([{text:this.prometheus,value:this.prometheus}]);case"node":return this.getNodesSingletone().then((function(t){return t.map((function(t){return{text:t.metadata.name,value:t.metadata.name}}))}));case"namespace":return this.getNamespaces().then((function(t){return Object(r.a)(e,void 0,void 0,(function(){var e,a,s,o,i,u;return Object(r.c)(this,(function(r){switch(r.label){case 0:switch(n[1]){case"deployment":return[3,1];case"statefulset":return[3,3];case"daemonset":return[3,5]}return[3,7];case 1:return[4,this.getDeployments()];case 2:return e=r.sent(),a=e.map((function(t){return t.metadata.namespace})),[2,t.filter((function(t){return a.includes(t.metadata.name)})).map((function(t){return{text:t.metadata.name,value:t.metadata.name}}))];case 3:return[4,this.getStatefulsets()];case 4:return s=r.sent(),o=s.map((function(t){return t.metadata.namespace})),[2,t.filter((function(t){return o.includes(t.metadata.name)})).map((function(t){return{text:t.metadata.name,value:t.metadata.name}}))];case 5:return[4,this.getDaemonsets()];case 6:return i=r.sent(),u=i.map((function(t){return t.metadata.namespace})),[2,t.filter((function(t){return u.includes(t.metadata.name)})).map((function(t){return{text:t.metadata.name,value:t.metadata.name}}))];case 7:return[2,t.map((function(t){return{text:t.metadata.name,value:t.metadata.name}}))]}}))}))}));case"pod":return this.getPods(n[1]).then((function(t){return t.map((function(t){return{text:t.metadata.name,value:t.metadata.name}}))}));case"deployment":return this.getDeploymentsSingletone().then((function(t){return t.filter((function(t){return t.metadata.namespace===n[1]})).map((function(t){return{text:t.metadata.name,value:t.metadata.name}}))}));case"daemonset":return this.getDaemonsetsSingletone().then((function(t){return t.filter((function(t){return t.metadata.namespace===n[1]})).map((function(t){return{text:t.metadata.name,value:t.metadata.name}}))}));case"statefulset":return this.getStateFulSetsSingletone().then((function(t){return t.filter((function(t){return t.metadata.namespace===n[1]})).map((function(t){return{text:t.metadata.name,value:t.metadata.name}}))}));case"containers":var a=null;switch(n[2]){case"deployment":a=this.getDeploymentsSingletone();break;case"daemonset":a=this.getDaemonsetsSingletone();break;case"statefulset":a=this.getStateFulSetsSingletone();break;case"pod":a=this.getPodsSingleton()}return a.then((function(t){return e.__parseContainers(t,n)}));case"nodeHost":return this.getNodesSingletone().then((function(t){var e=t.filter((function(t){return t.metadata.name===n[1]}))[0].status.addresses.filter((function(t){return"InternalIP"===t.type}))[0].address;return[{text:e,value:e}]}));default:return[]}},t.prototype.__get=function(t){var e=this.url;return this.accessViaToken&&(e+="/__proxy"),e+=t,this.backendSrv.datasourceRequest({url:e,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(t){return t.data}),(function(t){return t}))},t.prototype.__parseContainers=function(t,e){var n=t.filter((function(t){return t.metadata.namespace===e[1]})).filter((function(t){return t.metadata.name===e[3]}));if(!n.length)return[{text:"",value:""}];var r=[];(n=n[0]).spec.template?r=n.spec.template.spec.containers.map((function(t){return t.name})):n.spec.containers&&(r=n.spec.containers.map((function(t){return t.name})));var a=[];if(r.length>1){var s=r.join("|");a.push({text:"All",value:s})}return r.forEach((function(t){a.push({text:t,value:t})})),a},t.prototype.__addNamespace=function(t){return t?"namespaces/"+t+"/":""},t.prototype.getNamespaces=function(){return this.__get("/api/v1/namespaces").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Namespaces not received"]),[])}))},t.prototype.getDeployments=function(t){return void 0===t&&(t=null),this.__get("/apis/apps/v1/"+this.__addNamespace(t)+"deployments").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Deployments not received"]),[])}))},t.prototype.getStatefulsets=function(t){return void 0===t&&(t=null),this.__get("/apis/apps/v1/"+this.__addNamespace(t)+"statefulsets").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Statefulsets not received"]),[])}))},t.prototype.getDaemonsets=function(t){return void 0===t&&(t=null),this.__get("/apis/apps/v1/"+this.__addNamespace(t)+"daemonsets").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Daemonsets not received"]),[])}))},t.prototype.getPods=function(t){return this.__get("/api/v1/"+this.__addNamespace(t)+"pods").then((function(t){if(!t.items){return s.a.emit("alert-error",["Pods not received"]),new Error("Pods not received")}return t.items}))},t.prototype.getServices=function(t){return this.__get("/api/v1/"+this.__addNamespace(t)+"services").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Services not received"]),[])}))},t.prototype.getComponents=function(){return this.__get("/api/v1/componentstatuses").then((function(t){if(!t.items){var e="Component statuses not received";return s.a.emit("alert-error",[e]),new Error(e)}return t.items}))},t.prototype.getNodesSingletone=function(){return this.nodesPromise||(this.nodesPromise=this.__get("/api/v1/nodes").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Nodes (singleton) not received"]),[])}))),this.nodesPromise},t.prototype.getDeploymentsSingletone=function(t){return void 0===t&&(t=null),this.deploymentsPromise||(this.deploymentsPromise=this.__get("/apis/apps/v1/"+this.__addNamespace(t)+"deployments").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Deployments (singleton) not received"]),[])}))),this.deploymentsPromise},t.prototype.getDaemonsetsSingletone=function(t){return void 0===t&&(t=null),this.daemonsetsPromise||(this.daemonsetsPromise=this.__get("/apis/apps/v1/"+this.__addNamespace(t)+"daemonsets").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Daemonsets (singleton) not received"]),[])}))),this.daemonsetsPromise},t.prototype.getStateFulSetsSingletone=function(t){return void 0===t&&(t=null),this.statefulsetsPromise||(this.statefulsetsPromise=this.__get("/apis/apps/v1/"+this.__addNamespace(t)+"statefulsets").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Statefulsets (singleton) not received"]),[])}))),this.statefulsetsPromise},t.prototype.getPodsSingleton=function(t){return void 0===t&&(t=null),this.podsPromise||(this.podsPromise=this.__get("/api/v1/"+this.__addNamespace(t)+"pods").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Pods (singleton) not received"]),[])}))),this.podsPromise},t.prototype.getNodes=function(){return this.__get("/api/v1/nodes").then((function(t){if(!t.items){return s.a.emit("alert-error",["Nodes not received"]),new Error("Nodes not received")}return t.items}))},t.prototype.getJobs=function(){return this.__get("/apis/batch/v1/jobs").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["Jobs not received"]),[])}))},t.prototype.getCronJobs=function(){return this.__get("/apis/batch/v1beta1/cronjobs").then((function(t){return t.items?t.items:(s.a.emit("alert-error",["CronJobs not received"]),[])}))},t.prototype.getEvents=function(){return this.__get("/api/v1/events").then((function(t){return 403===t.status?(s.a.emit("alert-error",[t.status+" "+t.statusText,"Please, update ClusterRole to get new permissions"]),[]):t.items?t.items:(s.a.emit("alert-error",["Events not received"]),[])}))},t.$inject=["instanceSettings","backendSrv","templateSrv"],t}(),i=n(0),u=function(){function t(t,e,n,r){var a=this;this.backendSrv=n,this.$window=r,this.$scope=t,this.pageReady=!1,this.current.id?(this.current.jsonData.prom_name||(this.current.jsonData.prom_name=""),this.current.jsonData.refresh_pods_rate||(this.current.jsonData.refresh_pods_rate="60"),this.current.jsonData.cluster_url=this.current.url):this.current={type:"devopsprodidy-kubegraf-datasource",access:"proxy",jsonData:{refresh_pods_rate:"60",access_via_token:!1,prom_name:""}},this.setGrafanaVersion(r),this.getPrometheusList().then((function(){a.pageReady=!0,a.$scope.$apply()})),t.$watch("ctrl.current",(function(){a.setUrl()}))}return t.prototype.setGrafanaVersion=function(t){var e;try{e=t.grafanaBootData.settings.buildInfo.version.split(".")[0]}catch(t){e=5}this.version=e},t.prototype.setUrl=function(){this.current.jsonData.cluster_url=this.current.url},t.prototype.getPrometheusList=function(){var t=this;return this.backendSrv.get("/api/datasources").then((function(e){t.prometheusList=e.filter((function(t){return t.type===i.i}));var n=t.prometheusList.filter((function(t){return t.isDefault}));n.length>0&&""===t.current.jsonData.prom_name&&(t.current.jsonData.prom_name=n[0].name)}))},t.templateUrl="datasource/partials/config.html",t.$inject=["$scope","$injector","backendSrv","$window"],t}();n.d(e,"Datasource",(function(){return o})),n.d(e,"ConfigCtrl",(function(){return u}))},2:function(e,n){e.exports=t}})}));
//# sourceMappingURL=module.js.map